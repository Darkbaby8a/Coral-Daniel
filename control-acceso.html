<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Control de Acceso</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      padding: 15px;
    }
    h1 {
      text-align: center;
      margin-bottom: 15px;
    }
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    .tabs button {
      flex: 1;
      padding: 12px;
      font-size: 15px;
      border: none;
      border-radius: 8px;
      background: #ddd;
    }
    .tabs button.active {
      background: #1a73e8;
      color: white;
    }
    .section {
      display: none;
      background: white;
      padding: 15px;
      border-radius: 10px;
    }
    .section.active {
      display: block;
    }
    input, button {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      font-size: 16px;
    }
    button.action {
      background: #1a73e8;
      color: white;
      border: none;
      border-radius: 6px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 14px;
    }
    th, td {
      padding: 8px;
      border-bottom: 1px solid #ddd;
    }
    .ok { color: green; font-weight: bold; }
    .no { color: red; }
  </style>
</head>
<body>

<h1>üéüÔ∏è Control de Acceso</h1>

<!-- BOTONES -->
<div class="tabs">
  <button onclick="mostrar('qr')" class="active">üì∑ Escanear QR</button>
  <button onclick="mostrar('manual')">‚úçÔ∏è Pase Manual</button>
  <button onclick="mostrar('lista')">üìã Ver Lista</button>
</div>

<!-- QR -->
<div id="qr" class="section active">
  <h3>Escanear c√≥digo QR</h3>
  <div id="reader"></div>
</div>

<!-- MANUAL -->
<div id="manual" class="section">
  <h3>Registro manual</h3>
  <input type="text" id="familiaManual" placeholder="Familia">
  <button class="action" onclick="buscarFamilia()">Buscar</button>
</div>

<!-- LISTA -->
<div id="lista" class="section">
  <h3>Lista de invitados</h3>
  <table>
    <thead>
      <tr>
        <th>Familia</th>
        <th>Nombre</th>
        <th>Pases</th>
        <th>Usados</th>
      </tr>
    </thead>
    <tbody id="tabla"></tbody>
  </table>
</div>

<!-- INFO -->
<div id="infoBox" class="section">
  <h3 id="nombre"></h3>
  <p>Pases: <strong id="pases"></strong></p>
  <p>Usados: <strong id="usados"></strong></p>
  <p>Disponibles: <strong id="disponibles"></strong></p>

  <input type="number" id="pasesUsar" placeholder="Pases a utilizar">
  <button class="action" onclick="registrarEntrada()">Registrar entrada</button>

  <p id="mensaje"></p>
</div>

<script>
let invitadoActual = null;
let qrScanner = null;

/* ---------- NAVEGACI√ìN ---------- */
function mostrar(id) {
  document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
  document.querySelectorAll(".tabs button").forEach(b => b.classList.remove("active"));

  document.getElementById(id).classList.add("active");
  event.target.classList.add("active");

  if (id === "qr") iniciarQR();
  if (id === "lista") cargarLista();
}

/* ---------- QR ---------- */
function iniciarQR() {
  if (qrScanner) return;

  qrScanner = new Html5Qrcode("reader");
  qrScanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    txt => {
      try {
        const data = JSON.parse(txt);
        cargarInvitado(data.familia);
        qrScanner.stop();
      } catch {
        alert("QR inv√°lido");
      }
    }
  );
}

/* ---------- MANUAL ---------- */
function buscarFamilia() {
  const fam = document.getElementById("familiaManual").value.trim();
  if (fam) cargarInvitado(fam);
}

/* ---------- CARGAR INVITADO ---------- */
function cargarInvitado(familia) {
  fetch(`/.netlify/functions/obtener-invitado?familia=${encodeURIComponent(familia)}`)
    .then(r => r.json())
    .then(r => {
      if (!r.ok) return alert("No encontrado");

      invitadoActual = r.invitado;

      document.getElementById("infoBox").classList.add("active");
      document.getElementById("nombre").textContent = invitadoActual.displayname;
      document.getElementById("pases").textContent = invitadoActual.pases;
      document.getElementById("usados").textContent = invitadoActual.pasesuti || 0;
      document.getElementById("disponibles").textContent =
        invitadoActual.pases - (invitadoActual.pasesuti || 0);
    });
}

/* ---------- REGISTRAR ---------- */
function registrarEntrada() {
  const usar = parseInt(document.getElementById("pasesUsar").value);
  const disp = invitadoActual.pases - (invitadoActual.pasesuti || 0);

  if (!usar || usar <= 0) return alert("Cantidad inv√°lida");
  if (usar > disp) return alert("Excede pases");

  fetch("/.netlify/functions/registrar-acceso", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ familia: invitadoActual.familia, pasesUsar: usar })
  })
  .then(r => r.json())
  .then(r => {
    if (r.ok) {
      document.getElementById("mensaje").textContent = "‚úî Acceso registrado";
    }
  });
}

/* ---------- LISTA ---------- */
function cargarLista() {
  fetch("/.netlify/functions/listar-invitados")
    .then(r => r.json())
    .then(r => {
      if (!r.ok) return;
      const t = document.getElementById("tabla");
      t.innerHTML = "";
      r.invitados.forEach(i => {
        t.innerHTML += `
          <tr>
            <td>${i.familia}</td>
            <td>${i.displayname}</td>
            <td>${i.pases}</td>
            <td>${i.pasesuti || 0}</td>
          </tr>`;
      });
    });
}
</script>

</body>
</html>
