<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Control de Acceso</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
:root {
  --vino: #5a0f18;
  --vino-claro: #8b1e2d;
  --dorado: #b0935a;
  --fondo: #f4efe9;
}

/* ===== BASE ===== */
body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--fondo);
}

.access-body {
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 14px;
}

.access-card {
  width: 100%;
  max-width: 420px;
  background: #fff;
  border-radius: 22px;
  padding: 24px 20px;
  box-shadow: 0 20px 50px rgba(90,15,24,.25);
  border: 1px solid rgba(176,147,90,.45);
}

/* ===== HEADER ===== */
.access-title {
  text-align: center;
  font-size: 1.7rem;
  color: var(--vino);
  letter-spacing: 2px;
}

.separator-gold {
  text-align: center;
  color: var(--dorado);
  margin: 10px 0 20px;
}

/* ===== TABS ===== */
.access-tabs {
  display: flex;
  gap: 6px;
  margin-bottom: 20px;
}

.tab {
  flex: 1;
  padding: 12px;
  border-radius: 30px;
  border: 1px solid rgba(176,147,90,.6);
  background: #fff;
  color: var(--vino);
  font-size: .85rem;
  letter-spacing: 1px;
}

.tab.active {
  background: linear-gradient(135deg,var(--vino),var(--vino-claro));
  color: #fff;
  border: none;
}

/* ===== SECTIONS ===== */
.section {
  display: none;
}

.section.active {
  display: block;
}

.section-label {
  font-size: .8rem;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--vino);
  margin-bottom: 12px;
}

/* ===== QR ===== */
.qr-frame {
  padding: 12px;
  border-radius: 14px;
  border: 2px solid rgba(176,147,90,.6);
}

/* ===== INPUTS ===== */
input {
  width: 100%;
  padding: 14px;
  border-radius: 12px;
  border: 1px solid rgba(176,147,90,.6);
  font-size: 1rem;
  margin-bottom: 12px;
}

/* ===== BUTTON ===== */
.btn-primary {
  width: 100%;
  padding: 16px;
  border-radius: 40px;
  background: linear-gradient(135deg,var(--vino),var(--vino-claro));
  color: #fff;
  border: none;
  font-size: 1rem;
  letter-spacing: 1px;
}

/* ===== INFO ===== */
.info-box h3 {
  color: var(--vino);
  margin-bottom: 12px;
  text-align: center;
}

.passes-info {
  display: flex;
  justify-content: space-between;
  font-size: .9rem;
  margin-bottom: 14px;
}

.disponibles-ok { color: #146c43; font-weight: bold; }
.disponibles-cero { color: #b02a37; font-weight: bold; }

.status {
  margin-top: 10px;
  text-align: center;
  font-weight: bold;
  color: #146c43;
}

/* ===== RESULTADOS ===== */
.result-item {
  border: 1px solid rgba(176,147,90,.6);
  border-radius: 14px;
  padding: 12px;
  margin-bottom: 10px;
  cursor: pointer;
}

.result-item:hover {
  background: rgba(176,147,90,.12);
}

/* ===== LISTA ===== */
.access-table {
  width: 100%;
  font-size: .85rem;
  border-collapse: collapse;
}

.access-table th {
  color: var(--vino);
  border-bottom: 1px solid rgba(176,147,90,.4);
}

.access-table td {
  padding: 6px 0;
}

/* ===== MOBILE ===== */
@media (max-width: 480px) {
  .passes-info {
    flex-direction: column;
    gap: 6px;
  }
}
</style>
</head>

<body class="access-body">
<div class="access-card">

<h1 class="access-title">Control de Acceso</h1>
<div class="separator-gold">✦</div>

<div class="access-tabs">
  <button class="tab active" onclick="mostrar('qr',this)">QR</button>
  <button class="tab" onclick="mostrar('manual',this)">Manual</button>
  <button class="tab" onclick="mostrar('lista',this)">Lista</button>
</div>

<!-- QR -->
<div id="qr" class="section active">
  <p class="section-label">Escanear invitación</p>
  <div class="qr-frame"><div id="reader"></div></div>
</div>

<!-- MANUAL -->
<div id="manual" class="section">
  <p class="section-label">Buscar invitado</p>
  <input id="familiaManual" placeholder="Nombre o familia">
  <button class="btn-primary" onclick="buscar()">Buscar</button>
</div>

<!-- RESULTADOS -->
<div id="resultados" class="section">
  <p class="section-label">Selecciona invitado</p>
  <div id="listaResultados"></div>
</div>

<!-- INFO -->
<div id="infoBox" class="section info-box">
  <h3 id="nombre"></h3>

  <div class="passes-info">
    <span>Pases: <strong id="pases"></strong></span>
    <span>Usados: <strong id="usados"></strong></span>
    <span>Disponibles: <strong id="disponibles"></strong></span>
  </div>

  <input type="number" id="pasesUsar" placeholder="Pases a utilizar">
  <button class="btn-primary" onclick="registrar()">Registrar entrada</button>
  <p id="mensaje" class="status"></p>
</div>

<!-- LISTA -->
<div id="lista" class="section">
  <table class="access-table">
    <thead>
      <tr><th>Familia</th><th>Nombre</th><th>Pases</th><th>Usados</th></tr>
    </thead>
    <tbody id="tabla"></tbody>
  </table>
</div>

</div>

<script>
let invitadoActual = null;
let qrScanner = null;

/* ===== NAV ===== */
function mostrar(id, btn) {
  document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
  document.querySelectorAll(".tab").forEach(b => b.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  if (btn) btn.classList.add("active");
}

/* ===== QR ===== */
function iniciarQR() {
  if (qrScanner) return;
  qrScanner = new Html5Qrcode("reader");
  qrScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, txt => {
    try {
      const d = JSON.parse(txt);
      buscarInvitado(d.familia);
      qrScanner.stop();
    } catch { alert("QR inválido"); }
  });
}

/* ===== BUSCAR ===== */
function buscar() {
  const v = familiaManual.value.trim();
  if (v) buscarInvitado(v);
}

function buscarInvitado(nombre) {
  fetch(`/.netlify/functions/obtener-invitado-nombre?displayname=${encodeURIComponent(nombre)}`)
    .then(r => r.json())
    .then(r => {
      if (!r.ok) return alert("No encontrado");

      if (r.invitados.length === 1) {
        seleccionar(r.invitados[0]);
        return;
      }

      mostrar("resultados");
      listaResultados.innerHTML = "";
      r.invitados.forEach(i => {
        listaResultados.innerHTML += `
          <div class="result-item" onclick='seleccionar(${JSON.stringify(i)})'>
            <strong>${i.displayname}</strong><br>
            Familia: ${i.familia}<br>
            Disponibles:
            <span class="${i.disponibles > 0 ? "disponibles-ok" : "disponibles-cero"}">
              ${i.disponibles}
            </span>
          </div>`;
      });
    });
}

/* ===== SELECT ===== */
function seleccionar(i) {
  invitadoActual = i;
  mostrar("infoBox");

  nombre.textContent = i.displayname;
  pases.textContent = i.pases;
  usados.textContent = i.usados;
  disponibles.textContent = i.disponibles;
  disponibles.className = i.disponibles > 0 ? "disponibles-ok" : "disponibles-cero";
}

/* ===== REGISTRAR ===== */
function registrar() {
  const usar = parseInt(pasesUsar.value);
  if (!usar || usar <= 0) return alert("Cantidad inválida");
  if (usar > invitadoActual.disponibles) return alert("Excede pases");

  fetch("/.netlify/functions/registrar-acceso", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ familia: invitadoActual.familia, pasesUsar: usar })
  })
  .then(r => r.json())
  .then(r => {
    if (r.ok) mensaje.textContent = "✔ Acceso registrado";
  });
}

/* ===== LISTA ===== */
function cargarLista() {
  fetch("/.netlify/functions/listar-invitados")
    .then(r => r.json())
    .then(r => {
      if (!r.ok) return;
      tabla.innerHTML = "";
      r.invitados.forEach(i => {
        tabla.innerHTML += `<tr>
          <td>${i.familia}</td>
          <td>${i.displayname}</td>
          <td>${i.pases}</td>
          <td>${i.pasesuti || 0}</td>
        </tr>`;
      });
    });
}
</script>
</body>
</html>
