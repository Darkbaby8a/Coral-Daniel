<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Control de Acceso</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
   /* =========================
   CONTROL DE ACCESO – BODA
   ========================= */

.access-body {
  min-height: 100vh;
  background:
    url("https://www.transparenttextures.com/patterns/paper-3.png"),
    var(--fondo);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.access-card {
  max-width: 420px;
  width: 100%;
  background:
    url("https://www.transparenttextures.com/patterns/paper-3.png"),
    rgba(255,255,255,.95);
  border-radius: 22px;
  padding: 30px 24px;
  box-shadow: 0 25px 60px rgba(99,13,22,.25);
  border: 1px solid rgba(176,147,90,.45);
  text-align: center;
}

.access-title {
  font-size: 1.9rem;
  color: var(--vino);
  letter-spacing: 2px;
}

.separator-gold {
  color: var(--dorado);
  margin: 12px 0 25px;
}

/* TABS */
.access-tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 25px;
}

.tab {
  flex: 1;
  padding: 10px;
  border-radius: 30px;
  border: 1px solid rgba(176,147,90,.5);
  background: transparent;
  color: var(--vino);
  font-size: .85rem;
  letter-spacing: 1px;
}

.tab.active {
  background: linear-gradient(135deg, var(--vino), var(--vino-claro));
  color: white;
  border: none;
}

/* SECCIONES */
.section {
  display: none;
  animation: fadeUp .6s ease forwards;
}

.section.active {
  display: block;
}

.section-label {
  font-size: .85rem;
  letter-spacing: 2px;
  text-transform: uppercase;
  margin-bottom: 15px;
  color: var(--vino);
}

/* QR */
.qr-frame {
  padding: 18px;
  border-radius: 16px;
  background: linear-gradient(135deg,#fff,#f7f1ea);
  box-shadow: inset 0 0 0 2px rgba(176,147,90,.4);
}

/* INPUTS */
input {
  width: 100%;
  padding: 12px;
  border-radius: 10px;
  border: 1px solid rgba(176,147,90,.4);
  margin-bottom: 12px;
  font-size: 1rem;
}

/* BOTÓN */
.btn-primary {
  width: 100%;
  padding: 14px;
  border-radius: 40px;
  background: linear-gradient(135deg,var(--vino),var(--vino-claro));
  color: #fff;
  border: none;
  letter-spacing: 1px;
  font-size: .9rem;
  box-shadow: 0 10px 25px rgba(99,13,22,.4);
}

/* INFO */
.info-box h3 {
  color: var(--vino);
  margin-bottom: 15px;
}

.passes-info {
  display: flex;
  justify-content: space-between;
  font-size: .85rem;
  margin-bottom: 15px;
}

/* MENSAJES */
.status {
  margin-top: 12px;
  font-weight: 600;
  color: green;
}

/* TABLA */
.access-table {
  width: 100%;
  font-size: .85rem;
  border-collapse: collapse;
}

.access-table th {
  color: var(--vino);
  border-bottom: 1px solid rgba(176,147,90,.4);
  padding-bottom: 6px;
}

.access-table td {
  padding: 6px 0;
}
  </style>
</head>
<body class="access-body">

<div class="access-card">
  <h1 class="access-title">Control de Acceso</h1>
  <div class="separator-gold">✦</div>

  <!-- TABS -->
  <div class="access-tabs">
    <button class="tab active" onclick="mostrar('qr')">Escanear QR</button>
    <button class="tab" onclick="mostrar('manual')">Manual</button>
    <button class="tab" onclick="mostrar('lista')">Lista</button>
  </div>

  <!-- QR -->
  <div id="qr" class="section active">
    <p class="section-label">Presenta el código de invitación</p>
    <div class="qr-frame">
      <div id="reader"></div>
    </div>
  </div>

  <!-- MANUAL -->
  <div id="manual" class="section">
    <p class="section-label">Buscar familia</p>
    <input type="text" id="familiaManual" placeholder="Apellido familiar">
    <button class="btn-primary" onclick="buscarFamilia()">Buscar</button>
  </div>

  <!-- INFO -->
  <div id="infoBox" class="section info-box">
    <h3 id="nombre"></h3>

    <div class="passes-info">
      <span>Pases: <strong id="pases"></strong></span>
      <span>Usados: <strong id="usados"></strong></span>
      <span>Disponibles: <strong id="disponibles"></strong></span>
    </div>

    <input type="number" id="pasesUsar" placeholder="Pases a utilizar">
    <button class="btn-primary" onclick="registrarEntrada()">Registrar entrada</button>

    <p id="mensaje" class="status"></p>
  </div>

  <!-- LISTA -->
  <div id="lista" class="section">
    <table class="access-table">
      <thead>
        <tr>
          <th>Familia</th>
          <th>Nombre</th>
          <th>Pases</th>
          <th>Usados</th>
        </tr>
      </thead>
      <tbody id="tabla"></tbody>
    </table>
  </div>
</div>
<script>
let invitadoActual = null;
let qrScanner = null;

/* ---------- NAVEGACIÓN ---------- */
function mostrar(id) {
  document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
  document.querySelectorAll(".tabs button").forEach(b => b.classList.remove("active"));

  document.getElementById(id).classList.add("active");
  event.target.classList.add("active");

  if (id === "qr") iniciarQR();
  if (id === "lista") cargarLista();
}

/* ---------- QR ---------- */
function iniciarQR() {
  if (qrScanner) return;

  qrScanner = new Html5Qrcode("reader");
  qrScanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    txt => {
      try {
        const data = JSON.parse(txt);
        cargarInvitado(data.familia);
        qrScanner.stop();
      } catch {
        alert("QR inválido");
      }
    }
  );
}

/* ---------- MANUAL ---------- */
function buscarFamilia() {
  const fam = document.getElementById("familiaManual").value.trim();
  if (fam) cargarInvitado(fam);
}

/* ---------- CARGAR INVITADO ---------- */
function cargarInvitado(familia) {
  fetch(`/.netlify/functions/obtener-invitado-nombre?displayname=${encodeURIComponent(familia)}`)
    .then(r => r.json())
    .then(r => {
      if (!r.ok) return alert("No encontrado");

      invitadoActual = r.invitado;

      document.getElementById("infoBox").classList.add("active");
      document.getElementById("nombre").textContent = invitadoActual.displayname;
      document.getElementById("pases").textContent = invitadoActual.pases;
      document.getElementById("usados").textContent = invitadoActual.pasesuti || 0;
      document.getElementById("disponibles").textContent =
        invitadoActual.pases - (invitadoActual.pasesuti || 0);
    });
}

/* ---------- REGISTRAR ---------- */
function registrarEntrada() {
  const usar = parseInt(document.getElementById("pasesUsar").value);
  const disp = invitadoActual.pases - (invitadoActual.pasesuti || 0);

  if (!usar || usar <= 0) return alert("Cantidad inválida");
  if (usar > disp) return alert("Excede pases");

  fetch("/.netlify/functions/registrar-acceso", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ familia: invitadoActual.familia, pasesUsar: usar })
  })
  .then(r => r.json())
  .then(r => {
    if (r.ok) {
      document.getElementById("mensaje").textContent = "✔ Acceso registrado";
    }
  });
}

/* ---------- LISTA ---------- */
function cargarLista() {
  fetch("/.netlify/functions/listar-invitados")
    .then(r => r.json())
    .then(r => {
      if (!r.ok) return;
      const t = document.getElementById("tabla");
      t.innerHTML = "";
      r.invitados.forEach(i => {
        t.innerHTML += `
          <tr>
            <td>${i.familia}</td>
            <td>${i.displayname}</td>
            <td>${i.pases}</td>
            <td>${i.pasesuti || 0}</td>
          </tr>`;
      });
    });
}
</script>


</html>
